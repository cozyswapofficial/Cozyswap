<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <meta name="google-site-verification" content="7XULKztiphXCS0nzBXi2P6mK-F8-hqAVSxmkxZKqb-E" />
  <meta name="google-site-verification" content="6FBjhdnCVOh9PjkZPa-6C3jJ9ZvGNdwF6zCgJRsc6Ik" />

  <!-- âœ… SEO META TAGS FOR COZYSWAP -->
  <title>Cozyswap - Plasma Swap DEX | Swap, Liquidity, and Earn COZY</title>
  <meta name="title" content="Cozyswap - The Fastest Plasma Swap DEX" />
  <meta name="description" content="Cozyswap is a decentralized exchange (DEX) built on Plasma Chain. Swap tokens instantly, add liquidity, and earn rewards in COZY Token â€” fast, secure, and user-friendly." />
  <meta name="keywords" content="cozyswap, plasma swap, plasma chain, cozy token, dex, decentralized exchange, crypto swap, add liquidity, earn rewards, staking, defi, blockchain, exchange" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="English" />
  <meta name="author" content="Cozyswap Team" />
  <meta name="copyright" content="Â© 2025 Cozyswap" />

  <!-- ðŸŒ Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://cozyswap.net/" />
  <meta property="og:title" content="Cozyswap - Plasma Swap DEX on Plasma Chain" />
  <meta property="og:description" content="Trade, add liquidity, and earn rewards on Cozyswap â€” a next-gen Plasma Swap DEX powered by Plasma Chain." />
  <meta property="og:image" content="https://cozyswap.net/assets/cozy.png" />
  <meta property="og:site_name" content="Cozyswap" />

  <!-- ðŸ¦ Twitter META TAGS -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://cozyswap.net/" />
  <meta name="twitter:title" content="Cozyswap - Plasma Swap DEX" />
  <meta name="twitter:description" content="Swap, earn, and provide liquidity easily on Cozyswap â€” built for Plasma Chain and COZY Token." />
  <meta name="twitter:image" content="https://cozyswap.net/assets/cozy.png" />

  <!-- ðŸ”¹ FAVICON -->
  <link rel="icon" type="image/png" sizes="96x96" href="https://cozyswap.net/assets/cozy.png">
  <link rel="icon" type="image/svg+xml" href="https://cozyswap.net/assets/favicon.svg">
  <link rel="shortcut icon" href="https://cozyswap.net/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="https://cozyswap.net/assets/apple-touch-icon.png">

  <!-- ðŸ”¹ CANONICAL URL -->
  <link rel="canonical" href="https://cozyswap.net/" />

  <!-- ðŸ”¹ EXTRA SEO BOOST -->
  <meta name="theme-color" content="#7a00ff" />
  <meta name="application-name" content="Cozyswap" />
  <meta name="apple-mobile-web-app-title" content="Cozyswap" />
  <meta name="format-detection" content="telephone=no" />

  <!-- ðŸ”¹ JSON-LD STRUCTURED DATA (Google Rich Snippet) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Cozyswap",
    "url": "https://cozyswap.net/",
    "description": "Cozyswap is a Plasma Swap DEX for COZY Token â€” trade, add liquidity, and earn rewards easily.",
    "publisher": {
      "@type": "Organization",
      "name": "Cozyswap",
      "logo": {
        "@type": "ImageObject",
        "url": "https://cozyswap.net/assets/cozy.png"
      }
    },
    "sameAs": [
      "https://twitter.com/CozySwap_net",
      "https://t.me/CozySwap_net",
      "https://github.com/cozyswap1"
    ]
  }
  </script>

  <link rel="icon" href="https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png" />
  <style>
    /* Modern Variable Definitions */
    :root {
      --bg-color: #0d1117;
      --card-bg: #161b22;
      --card-border: #30363d;
      --input-bg: #0d1117;
      --input-border: #30363d;
      --text-main: #c9d1d9;
      --text-muted: #8b949e;
      --primary-color: #7a00ff;
      --primary-hover: #9e47ff;
      --secondary-color: #238636;
      --danger-color: #da3633;
      --highlight: #58a6ff;
      --radius-l: 24px;
      --radius-m: 16px;
      --radius-s: 12px;
      --shadow-card: 0 16px 32px rgba(1, 4, 9, 0.85);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * { box-sizing: border-box; }
    
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-family);
    }

    .wrap {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 420px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }

    .small {
      font-size: 12px;
      color: var(--text-muted);
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      position: relative;
    }

    .btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: var(--radius-m);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      font-size: 13px;
    }

    .btn:hover {
      background: var(--primary-hover);
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-l);
      padding: 8px;
      box-shadow: var(--shadow-card);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 12px 20px;
    }

    .settings-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
    }

    /* Input Panels */
    .swap-panel {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius-m);
      padding: 12px;
      transition: border-color 0.2s;
    }

    .swap-panel:hover, .swap-panel:focus-within {
      border-color: #58a6ff;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .panel-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .amount-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      font-weight: 500;
      width: 100%;
      outline: none;
      padding: 0;
    }

    .amount-input::placeholder {
      color: #484f58;
    }

    .max-btn {
      color: var(--highlight);
      background: transparent;
      border: none;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Token Selector */
    .token-select-container {
      position: relative;
    }

    .selected-token {
      display: flex;
      align-items: center;
      background: #21262d;
      padding: 4px 8px 4px 6px;
      border-radius: 16px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      min-width: 90px;
      justify-content: space-between;
    }

    .selected-token:hover {
      background: #30363d;
    }

    .token-logo-sm {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .token-symbol {
      font-weight: 600;
      color: #fff;
      font-size: 14px;
      margin-right: 6px;
    }

    .dropdown-arrow {
      font-size: 10px;
    }

    /* Swap Arrow */
    .swap-arrow-container {
      position: relative;
      height: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
    }

    .swap-arrow-btn {
      background: var(--card-bg);
      border: 4px solid var(--bg-color); /* Creates gap effect */
      border-radius: 10px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .swap-arrow-btn:hover {
      color: #fff;
      transform: scale(1.1);
    }

    /* Dropdown */
    .token-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 12px;
      width: 280px;
      max-height: 350px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      margin-top: 8px;
    }

    .token-search {
      padding: 8px;
      border-bottom: 1px solid #30363d;
    }

    .token-search input {
      width: 100%;
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 8px;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
    }

    /* Compact token option styling */
    .token-option {
      padding: 6px 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .token-option:hover {
      background: #21262d;
    }

    /* Price Display */
    .price-display-container {
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .price-value {
      color: var(--text-main);
      font-weight: 500;
    }

    /* Main Action Button */
    .action-btn {
      width: 100%;
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 14px;
      border-radius: var(--radius-m);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }

    .action-btn:hover {
      background: var(--primary-hover);
    }

    .unwrap-btn {
      background: #f59e0b;
      color: #fff;
      border: none;
      border-radius: var(--radius-m);
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      margin-top: 8px;
    }
    .unwrap-btn:hover { background: #d97706; }

    /* Footer / Settings */
    .swap-details {
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: var(--input-bg);
      font-size: 12px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    .detail-row:last-child { margin-bottom: 0; }

    .green { color: #2ea043; }
    .yellow { color: #db8e0d; }
    .red { color: #f85149; }

    /* Nav Menu Dropdown */
    .menu-dropdown {
      position: absolute;
      top: 100%;
      right: 0; /* Align right to avoid overflow */
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 4px 0;
      min-width: 120px;
      display: none;
      z-index: 1001;
      margin-top: 8px;
    }
    .menu-option {
      padding: 8px 16px;
      cursor: pointer;
      color: var(--text-main);
      font-size: 13px;
      display: block;
      text-decoration: none;
    }
    .menu-option:hover { background: #30363d; color: #fff; }

    .menu-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: var(--text-main);
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    .menu-btn:hover { background: #30363d; color: #fff; }

    /* Wallet Dropdown */
    .wallet-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 4px 0;
      min-width: 160px;
      display: none;
      z-index: 1000;
      margin-top: 8px;
    }
    .wallet-option {
      padding: 8px 16px;
      cursor: pointer;
      color: var(--text-main);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .wallet-option:hover { background: #30363d; }
    .wallet-option.disconnect { color: #f85149; }

    /* Add Token Button inside dropdown */
    .add-token-container {
      padding: 6px;
      border-top: 1px solid #30363d;
      text-align: center;
    }
    .add-token-btn {
      width: 100%;
      background: #21262d;
      border: 1px solid #30363d;
      color: var(--text-muted);
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .add-token-btn:hover {
      background: #30363d;
      color: #fff;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: #238636;
      color: #fff;
      font-size: 13px;
      border-radius: 8px;
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .toast.error { background: #da3633; }

    /* Custom Scrollbar for token list */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }

    .token-info { display: flex; flex-direction: column; }
    .token-name { font-size: 10px; color: var(--text-muted); }
    .token-balance { margin-left: auto; font-size: 12px; text-align: right; }
    .token-usd { font-size: 10px; color: var(--text-muted); display: block; text-align: right; }
    .copy-btn { margin-left: 8px; background: transparent; border: none; cursor: pointer; color: var(--text-muted); }
    
    .usd-price-display {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
        height: 14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="app">
      <div class="brand">
        <img id="logoImg" class="logo" src="https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png" alt="Cozy" />
        <div>
          <h1 style="margin:0">CozySwap</h1>
        </div>
      </div>
      <div class="actions">
        <!-- New Menu Dropdown (Compact) -->
        <div style="position:relative">
          <button class="menu-btn" onclick="toggleMenuDropdown()">
             <span>â‹®</span>
          </button>
          <div id="menuDropdown" class="menu-dropdown">
             <a href="https://cozyswap.net/liquidity" class="menu-option">Liquidity</a>
             <a href="https://cozyswap.net/staking" class="menu-option">Staking</a>
          </div>
        </div>

        <div style="position:relative">
          <button id="connectBtn" class="btn">Connect</button>
          <div id="walletDropdown" class="wallet-dropdown">
            <div class="wallet-option" onclick="copyAddress(window.account)">
              <span>ðŸ“‹</span> Copy Address
            </div>
            <div class="wallet-option disconnect" onclick="disconnectWallet()">
              <span>ðŸšª</span> Disconnect
            </div>
          </div>
        </div>
        <span id="status" style="display:none"></span>
      </div>
    </header>

    <!-- Main Swap Card -->
    <div class="app">
      <div class="card">
        <div class="card-header">
          <strong style="color: #fff; font-size: 16px;">Swap</strong>
          <div class="small" style="display:flex; gap:8px;">
             <!-- Settings Icon could go here -->
          </div>
        </div>

        <!-- FROM PANEL -->
        <div class="swap-panel">
          <div class="panel-header">
            <label>From</label>
            <div class="small">Balance: <span id="fromBalance">â€”</span> <button id="maxFrom" class="max-btn">Max</button></div>
          </div>
          <div class="panel-content">
            <input id="fromAmount" type="text" class="amount-input" placeholder="0.0" />
            
            <div class="token-select-container">
              <div class="selected-token" onclick="toggleDropdown('from')">
                <div style="display:flex;align-items:center;">
                  <img id="selectedFromLogo" src="" class="token-logo-sm">
                  <span id="selectedFromSymbol" class="token-symbol">XPL</span>
                </div>
                <span class="dropdown-arrow">â–¼</span>
              </div>
              <div id="fromDropdown" class="token-dropdown"></div>
            </div>
          </div>
          <div class="usd-price-display" id="fromUsdDisplay"></div>
        </div>

        <!-- ARROW -->
        <div class="swap-arrow-container">
           <div id="flip" class="swap-arrow-btn">
             <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
           </div>
        </div>

        <!-- TO PANEL -->
        <div class="swap-panel">
          <div class="panel-header">
            <label>To</label>
            <div class="small">Balance: <span id="toBalance">â€”</span></div>
          </div>
          <div class="panel-content">
             <div class="amount-input" id="toReadable" style="padding-top:2px;">â€”</div>
             <div class="token-select-container">
                <div class="selected-token" onclick="toggleDropdown('to')">
                  <div style="display:flex;align-items:center;">
                    <img id="selectedToLogo" src="" class="token-logo-sm">
                    <span id="selectedToSymbol" class="token-symbol">COZY</span>
                  </div>
                  <span class="dropdown-arrow">â–¼</span>
                </div>
                <div id="toDropdown" class="token-dropdown"></div>
             </div>
          </div>
          <div class="usd-price-display" id="toUsdDisplay"></div>
        </div>

        <!-- PRICE DISPLAY (New) -->
        <div class="price-display-container">
           <div id="priceDisplay" class="price-value"></div>
           <div id="priceImpactContainer" class="small"></div>
        </div>

        <!-- DETAILS (Slippage etc) -->
        <div class="swap-details">
           <div class="detail-row">
             <span>Slippage Tolerance</span>
             <span><input id="slippage" type="text" value="0.5" style="background:transparent;border:none;color:var(--highlight);width:30px;text-align:right;">%</span>
           </div>
           <div class="detail-row">
             <span>Deadline</span>
             <span><input id="deadline" type="number" value="10" style="background:transparent;border:none;color:var(--highlight);width:30px;text-align:right;"> min</span>
           </div>
           <div class="detail-row">
              <span>Price Impact</span>
              <span id="priceImpact" class="muted">â€”</span>
           </div>
           <div class="detail-row">
              <span>Route</span>
              <span id="liquidityInfo">Plasma Router</span>
           </div>
        </div>

        <!-- MAIN BUTTON -->
        <button id="approveOrSwap" class="action-btn">Connect Wallet</button>
        
        <div id="txHash" class="txhash" style="text-align:center; margin-top:12px; font-size:12px;"></div>
      </div>

      <!-- Footer Links -->
      <footer style="text-align:center; font-size:11px; color:var(--text-muted); padding-bottom:40px;">
        <a href="terms.html" style="color:var(--text-muted); text-decoration:none;">Terms</a> &nbsp;â€¢&nbsp;
        <a href="disclaimer.html" style="color:var(--text-muted); text-decoration:none;">Disclaimer</a> &nbsp;â€¢&nbsp;
        <a href="privacy.html" style="color:var(--text-muted); text-decoration:none;">Privacy</a>
        <div style="margin-top:8px;">Â© 2025 CozySwap</div>
      </footer>
    </div>
  </div>

  <script>
  // ==================== FUNGSI GLOBAL ====================
  let account = null;

  // Fungsi global untuk toggle menu dropdown
  function toggleMenuDropdown() {
    const dropdown = document.getElementById('menuDropdown');
    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
    } else {
      dropdown.style.display = 'block';
    }
  }

  // Fungsi global untuk toggle dropdown
  function toggleDropdown(type) {
    const dropdown = document.getElementById(`${type}Dropdown`);
    const container = dropdown.closest('.token-select-container');
    const allDropdowns = document.querySelectorAll('.token-dropdown');

    allDropdowns.forEach(dd => {
      if (dd.id !== `${type}Dropdown`) {
        dd.style.display = 'none';
        dd.closest('.token-select-container')?.classList.remove('open');
      }
    });

    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
      container.classList.remove('open');
    } else {
      dropdown.style.display = 'block';
      container.classList.add('open');
    }
  }

  // Fungsi untuk toggle wallet dropdown
  function toggleWalletDropdown() {
    const dropdown = document.getElementById('walletDropdown');
    if (dropdown.style.display === 'block') {
      dropdown.style.display = 'none';
    } else {
      dropdown.style.display = 'block';
    }
  }

  // Tutup dropdown saat klik di luar
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.token-select-container')) {
      document.querySelectorAll('.token-dropdown').forEach(dd => {
        dd.style.display = 'none';
        dd.closest('.token-select-container')?.classList.remove('open');
      });
    }
    if (!e.target.closest('#connectBtn') && !e.target.closest('#walletDropdown')) {
      document.getElementById('walletDropdown').style.display = 'none';
    }
    if (!e.target.closest('.menu-btn') && !e.target.closest('#menuDropdown')) {
      document.getElementById('menuDropdown').style.display = 'none';
    }
  });

  // Fungsi global untuk copy address
  function copyAddress(addr) {
    if (!addr) return showToast("âš ï¸ Address not found", true);
    navigator.clipboard.writeText(addr)
      .then(() => showToast("âœ… Address copied to clipboard"))
      .catch(() => showToast("âŒ Failed to copy address", true));
  }

  // Fungsi global untuk show toast
  function showToast(message, isError = false) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.className = isError ? "toast error" : "toast";
    document.body.appendChild(toast);

    setTimeout(() => toast.style.opacity = "1", 10);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 400);
    }, 2500);
  }

  // Fungsi disconnect wallet
  function disconnectWallet() {
    account = null;
    window.account = null;
    document.getElementById('connectBtn').innerText = 'Connect Wallet';
    document.getElementById('connectBtn').onclick = connectWallet;
    document.getElementById('walletDropdown').style.display = 'none';
    document.getElementById('status').innerText = 'Disconnected';
    document.getElementById('fromBalance').innerText = 'â€”';
    document.getElementById('toBalance').innerText = 'â€”';
    showToast("Wallet disconnected");

    // Reset UI state
    if (window.provider) {
      window.provider = null;
      window.signer = null;
    }
  }

  // Fungsi filter tokens
  window.filterTokens = function(type, searchTerm) {
    const dropdown = document.getElementById(`${type}Dropdown`);
    const options = dropdown.querySelectorAll('.token-option[data-address]');
    let hasVisible = false;

    options.forEach(option => {
      const symbol = option.querySelector('.token-symbol')?.textContent.toLowerCase() || '';
      const name = option.querySelector('.token-name')?.textContent.toLowerCase() || '';

      const matches = symbol.includes(searchTerm.toLowerCase()) || 
                     name.includes(searchTerm.toLowerCase());

      option.style.display = matches ? 'flex' : 'none';
      if (matches) hasVisible = true;
    });

    // Show/hide no tokens message
    const noTokens = dropdown.querySelector('.no-tokens');
    if (noTokens) {
      noTokens.style.display = hasVisible ? 'none' : 'block';
    }
  }
  </script>

  <script>
  (async ()=>{
    // Load ethers dari CDN
    const CDNS = [
      'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js'
    ];

    async function loadEthers() {
      if (window.ethers) return window.ethers;
      for (const url of CDNS) {
        try {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.onload = () => resolve(window.ethers);
            script.onerror = reject;
            document.head.appendChild(script);
          });
          if (window.ethers) return window.ethers;
        } catch (e) {
          console.warn('Failed to load from', url, e);
        }
      }
      throw new Error('Could not load ethers.js');
    }

    // Load ethers
    const ethers = await loadEthers();
    const { utils, BigNumber, providers, Contract } = ethers;

    const RPC = 'https://plasma-mainnet.g.alchemy.com/v2/MuLXFm60Tsz3ntyrSC1O4';
    const CHAIN_ID = 9745;
    const CHAIN_ID_HEX = '0x2611';
    const ROUTER = '0x89E695B38610e78a77Fb310458Dfd855505AD239';
    const FACTORY = '0xa252e44D3478CeBb1a3D59C9146CD860cb09Ec93';
    const WXPL = '0x6100E367285b01F48D07953803A2d8dCA5D19873';
    
    // Stablecoin for pricing (USDT0)
    const USDT_ADDRESS = '0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb';

    const ERC20 = [
      'function decimals() view returns (uint8)',
      'function symbol() view returns (string)',
      'function balanceOf(address) view returns (uint256)',
      'function approve(address spender,uint256 amount) returns (bool)',
      'function allowance(address owner,address spender) view returns (uint256)'
    ];

    const ROUTER_ABI = [
      'function getAmountsOut(uint256,address[]) view returns (uint256[])',
      'function swapExactTokensForTokens(uint256,uint256,address[],address,uint256)',
      'function swapExactETHForTokens(uint256,address[],address,uint256) payable',
      'function swapExactTokensForETH(uint256,uint256,address[],address,uint256)'
    ];

    const FACTORY_ABI = [
      'function getPair(address,address) view returns (address)'
    ];

    const PAIR_ABI = [
      'function getReserves() view returns (uint112,uint112,uint32)',
      'function token0() view returns (address)',
      'function token1() view returns (address)'
    ];

    // Elements
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const fromAmountEl = document.getElementById('fromAmount');
    const fromReadable = document.getElementById('fromReadable'); // This was used for something else, but we now have fromUsdDisplay
    const toReadable = document.getElementById('toReadable');
    const priceImpactEl = document.getElementById('priceImpact');
    const liquidityInfoEl = document.getElementById('liquidityInfo');
    const approveOrSwapBtn = document.getElementById('approveOrSwap');
    const txHashEl = document.getElementById('txHash');
    const maxFromBtn = document.getElementById('maxFrom');
    const flipBtn = document.getElementById('flip');
    const fromBalanceEl = document.getElementById('fromBalance');
    const toBalanceEl = document.getElementById('toBalance');
    const priceDisplay = document.getElementById('priceDisplay');
    const fromUsdDisplay = document.getElementById('fromUsdDisplay');
    const toUsdDisplay = document.getElementById('toUsdDisplay');

    let provider = null;
    let signer = null;
    let router = null;
    let factory = null;

    // Default tokens dengan XPL dan COZY sebagai default
    const DEFAULTS = [
      {symbol: 'XPL', address: 'XPL_NATIVE', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/xpl.png'},
      {symbol: 'COZY', address: '0x06e2ef46662834f4e42dbf9ff9222b077c57df5c', logoURI: 'https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png'},
      {symbol: 'WXPL', address: WXPL, logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/xpl.png'},
      {symbol: 'WETH', address: '0x9895D81bB462A195b4922ED7De0e3ACD007c32CB', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/weth.png'},
      {symbol: 'USDT0', address: '0xB8CE59FC3717ada4C02eaDF9682A9e934F625ebb', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/USDT0.png'},
      {symbol: 'CRY', address: '0x59cdd876f3b8a4e81ecb467078ea009f80052fa2', logoURI: 'https://cozyswap1.github.io/Cozyswap/assets/crybaby.png'}
    ];

    // Token management
    const TOKENS_KEY = 'cozy_tokens_v2';
    function loadTokens() {
      try {
        const raw = localStorage.getItem(TOKENS_KEY);
        if (raw) return JSON.parse(raw);
      } catch (e) {}
      return DEFAULTS.slice();
    }

    function saveTokens(list) {
      localStorage.setItem(TOKENS_KEY, JSON.stringify(list));
    }

    let tokens = loadTokens();
    let selectedFromToken = tokens[0]; // XPL sebagai default
    let selectedToToken = tokens[1];   // COZY sebagai default

    // Helper function untuk default logo
    function getDefaultLogo(symbol) {
      const defaultLogos = {
        'XPL': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzZjNjNmZiIvPjwvc3ZnPg==',
        'WXPL': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzAwYzZmZiIvPjwvc3ZnPg==',
        'COZY': 'https://photos.pinksale.finance/file/pinksale-logo-upload/1760207026339-3c980e075709984d5362d951f45695a5.png'
      };
      return defaultLogos[symbol] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSIxMCIgZmlsbD0iIzlmOWY5ZiIvPjwvc3ZnPg==';
    }

    // âœ… FUNGSI: Refresh selectors dengan balance display
    function refreshSelectors() {
      const fromDropdown = document.getElementById('fromDropdown');
      const toDropdown = document.getElementById('toDropdown');

      // Clear existing options
      fromDropdown.innerHTML = '';
      toDropdown.innerHTML = '';

      // Add search bar to both dropdowns
      const searchHTML = `
        <div class="token-search">
          <input type="text" placeholder="Search token..." 
                 oninput="filterTokens('${'from'}', this.value)">
        </div>
      `;

      fromDropdown.innerHTML = searchHTML;
      toDropdown.innerHTML = searchHTML.replace("filterTokens('from',", "filterTokens('to',");

      // Create token options untuk kedua dropdown dengan balance
      tokens.forEach(token => {
        const displayAddress = token.address === 'XPL_NATIVE' ? 'Native' : 
                              `${token.address.substring(0, 4)}...${token.address.substring(38)}`;

        const tokenHTML = `
          <div class="token-option" data-address="${token.address}">
            <img src="${token.logoURI || getDefaultLogo(token.symbol)}" 
                 alt="${token.symbol}" 
                 class="token-logo-sm"
                 onerror="this.src='${getDefaultLogo(token.symbol)}'">
            <div class="token-info">
              <span class="token-symbol">${token.symbol}</span>
              <span class="token-name">${displayAddress}</span>
            </div>
            <div style="text-align:right; margin-left:auto;">
              <div class="token-balance" id="dropdownBalance-${token.symbol}-${token.address.substring(0, 6)}">â€”</div>
              <div class="token-usd" id="dropdownUsd-${token.symbol}-${token.address.substring(0, 6)}"></div>
            </div>
            <button class="copy-btn" title="Copy address" 
                    onclick="event.stopPropagation(); copyAddress('${token.address}')">ðŸ“‹</button>
          </div>
        `;

        fromDropdown.innerHTML += tokenHTML;
        toDropdown.innerHTML += tokenHTML;
      });

      // Add custom token button at the bottom
      const addTokenHTML = `
        <div class="add-token-container">
           <button class="add-token-btn" onclick="addCustomToken()">+ Manage / Add Token</button>
        </div>
      `;
      fromDropdown.innerHTML += addTokenHTML;
      toDropdown.innerHTML += addTokenHTML;

      // Add no tokens message
      fromDropdown.innerHTML += '<div class="no-tokens" style="display: none;">No tokens found</div>';
      toDropdown.innerHTML += '<div class="no-tokens" style="display: none;">No tokens found</div>';

      // Re-attach event listeners
      reattachTokenEventListeners();

      // Set default tokens
      selectToken('from', selectedFromToken);
      selectToken('to', selectedToToken);

      // Update dropdown balances
      updateDropdownBalances();
      // Update USD prices
      updateUsdPrices();
    }

    // âœ… FUNGSI: Get USD Price
    async function getUsdPrice(tokenAddress) {
      if (!router) return 0;
      // If token is USDT, price is 1
      if (tokenAddress.toLowerCase() === USDT_ADDRESS.toLowerCase()) return 1;

      const path = [];
      const tokenIn = tokenAddress === 'XPL_NATIVE' ? WXPL : tokenAddress;
      
      try {
         // Try direct path: Token -> USDT
         const path1 = [tokenIn, USDT_ADDRESS];
         
         const dec = tokenAddress === 'XPL_NATIVE' ? 18 : await (new Contract(tokenIn, ERC20, provider)).decimals();
         const unitAmount = utils.parseUnits("1", dec);
         
         const amounts = await router.getAmountsOut(unitAmount, path1);
         // USDT usually has 6 or 18 decimals. USDT0 on Plasma? 
         // We check decimals of USDT0
         const usdtContract = new Contract(USDT_ADDRESS, ERC20, provider);
         const usdtDec = await usdtContract.decimals();
         
         return parseFloat(utils.formatUnits(amounts[amounts.length-1], usdtDec));
      } catch(e) {
         try {
            // Try path: Token -> WXPL -> USDT
            if (tokenIn.toLowerCase() !== WXPL.toLowerCase()) {
               const path2 = [tokenIn, WXPL, USDT_ADDRESS];
               const dec = tokenAddress === 'XPL_NATIVE' ? 18 : await (new Contract(tokenIn, ERC20, provider)).decimals();
               const unitAmount = utils.parseUnits("1", dec);
               
               const amounts = await router.getAmountsOut(unitAmount, path2);
               const usdtContract = new Contract(USDT_ADDRESS, ERC20, provider);
               const usdtDec = await usdtContract.decimals();
               return parseFloat(utils.formatUnits(amounts[amounts.length-1], usdtDec));
            }
         } catch(e2) {
            return 0;
         }
      }
      return 0;
    }

    async function updateUsdPrices() {
       if (!provider || !router) return;
       
       // Update dropdown prices
       for (const token of tokens) {
          const price = await getUsdPrice(token.address);
          if (price > 0) {
             const priceEls = document.querySelectorAll(`#dropdownUsd-${token.symbol}-${token.address.substring(0, 6)}`);
             priceEls.forEach(el => {
                // If price < 0.01 show more decimals
                el.innerText = price < 0.01 ? `$${price.toFixed(6)}` : `$${price.toFixed(2)}`;
             });
          }
       }

       // Update Panel Prices
       updatePanelUsdPrices();
    }

    async function updatePanelUsdPrices() {
        if (!provider || !router) return;
        
        // From Price
        const priceFrom = await getUsdPrice(selectedFromToken.address);
        if (priceFrom > 0) {
            fromUsdDisplay.innerText = priceFrom < 0.01 ? `~$${priceFrom.toFixed(6)}` : `~$${priceFrom.toFixed(2)}`;
        } else {
            fromUsdDisplay.innerText = '';
        }

        // To Price
        const priceTo = await getUsdPrice(selectedToToken.address);
        if (priceTo > 0) {
            toUsdDisplay.innerText = priceTo < 0.01 ? `~$${priceTo.toFixed(6)}` : `~$${priceTo.toFixed(2)}`;
        } else {
            toUsdDisplay.innerText = '';
        }
    }

    // Function to add custom token (globally accessible)
    window.addCustomToken = async () => {
      const addr = prompt('Paste custom token address'); 
      if (!addr) return; 
      if (!utils.isAddress(addr)) return alert('Invalid address');

      const c = new Contract(addr, ERC20, provider || new providers.JsonRpcProvider(RPC));
      let sym = 'TOKEN'; 
      try { 
        sym = await c.symbol(); 
      } catch (e) {}

      if (!confirm('Add custom token ' + sym + '\nAddress: ' + addr + '\nWarning: adding custom tokens can be risky. Proceed?')) return;

      tokens.push({symbol: sym, address: addr, logoURI: ''}); 
      saveTokens(tokens); 
      refreshSelectors(); 
      alert('Token added: ' + sym);
    };

    // âœ… FUNGSI: Update balances di dropdown
    async function updateDropdownBalances() {
      if (!account || !provider) return;

      try {
        for (const token of tokens) {
          let balance = 'â€”';

          if (token.address === 'XPL_NATIVE') {
            const bal = await provider.getBalance(account);
            // Format to 4 decimals
            balance = parseFloat(utils.formatUnits(bal, 18)).toFixed(4);
          } else {
            try {
              const c = new Contract(token.address, ERC20, provider);
              const dec = await c.decimals();
              const bal = await c.balanceOf(account);
              // Format to 4 decimals
              balance = parseFloat(utils.formatUnits(bal, dec)).toFixed(4);
            } catch (e) {
              balance = '0';
            }
          }

          // Update balance di kedua dropdown
          const balanceEls = document.querySelectorAll(`#dropdownBalance-${token.symbol}-${token.address.substring(0, 6)}`);
          balanceEls.forEach(el => {
            el.innerText = balance;
          });
        }
      } catch (e) {
        console.warn('Dropdown balance error:', e);
      }
    }

    // âœ… FUNGSI: Reattach event listeners
    function reattachTokenEventListeners() {
      const fromDropdown = document.getElementById('fromDropdown');
      const toDropdown = document.getElementById('toDropdown');

      // Untuk FROM dropdown
      fromDropdown.querySelectorAll('.token-option[data-address]').forEach(option => {
        const address = option.getAttribute('data-address');
        option.onclick = (e) => {
          if (!e.target.classList.contains("copy-btn")) {
            const token = tokens.find(t => t.address === address);
            if (token) selectToken('from', token);
          }
        };
      });

      // Untuk TO dropdown  
      toDropdown.querySelectorAll('.token-option[data-address]').forEach(option => {
        const address = option.getAttribute('data-address');
        option.onclick = (e) => {
          if (!e.target.classList.contains("copy-btn")) {
            const token = tokens.find(t => t.address === address);
            if (token) selectToken('to', token);
          }
        };
      });
    }

    // âœ… FUNGSI: Select token
    function selectToken(type, token) {
      const logoEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Logo`);
      const symbolEl = document.getElementById(`selected${type.charAt(0).toUpperCase() + type.slice(1)}Symbol`);
      const dropdownEl = document.getElementById(`${type}Dropdown`);
      const container = dropdownEl.closest('.token-select-container');

      // Update selected token display
      logoEl.src = token.logoURI || getDefaultLogo(token.symbol);
      logoEl.onerror = function() {
        this.src = getDefaultLogo(token.symbol);
      };
      symbolEl.textContent = token.symbol;

      // Close dropdown
      dropdownEl.style.display = 'none';
      container.classList.remove('open');

      // Clear search input
      const searchInput = dropdownEl.querySelector('.token-search input');
      if (searchInput) searchInput.value = '';

      // Reset filter
      window.filterTokens(type, '');

      // Update active states
      dropdownEl.querySelectorAll('.token-option').forEach(option => {
        option.classList.remove('active');
        const address = option.getAttribute('data-address');
        if (address === token.address) {
          option.classList.add('active');
        }
      });

      // Store selected tokens
      if (type === 'from') {
        selectedFromToken = token;
      } else {
        selectedToToken = token;
      }

      // Update button Swap/Unwrap
      updateSwapButton();

      // Update balances dan compute output
      updateBalances();
      updatePanelUsdPrices();
      computeOutput();
    }

    // âœ… FUNGSI: Auto ganti button Swap â†” Unwrap
    function updateSwapButton() {
      const from = selectedFromToken.address;
      const to = selectedToToken.address;
      const isXPLPair = 
        (from === 'XPL_NATIVE' && to === WXPL) ||
        (from === WXPL && to === 'XPL_NATIVE');

      const swapBtn = document.getElementById('approveOrSwap');

      if (isXPLPair) {
        swapBtn.textContent = from === 'XPL_NATIVE' ? 'Wrap' : 'Unwrap';
        swapBtn.className = 'unwrap-btn';
        swapBtn.onclick = executeUnwrap;
      } else {
        swapBtn.textContent = 'Swap';
        swapBtn.className = 'action-btn';
        swapBtn.onclick = executeSwap;
      }
    }

    // âœ… FUNGSI: Execute Unwrap WXPL â†’ XPL
    async function executeUnwrap() {
      try {
        if (!window.ethereum) return alert('Connect wallet first');
        if (!signer) signer = new providers.Web3Provider(window.ethereum).getSigner();

        const owner = await signer.getAddress();
        const from = selectedFromToken.address;
        const to = selectedToToken.address;
        const amtStr = (fromAmountEl.value || '').trim();

        if (!amtStr) return alert('Enter amount');

        // Pastikan ini benar XPL/WXPL pair
        const isWrap = (from === 'XPL_NATIVE' && to === WXPL); // XPL â†’ WXPL
        const isUnwrap = (from === WXPL && to === 'XPL_NATIVE'); // WXPL â†’ XPL

        if (!isUnwrap && !isWrap) {
          alert('Invalid XPL/WXPL pair');
          return;
        }

        if (isUnwrap) {
          // UNWRAP: WXPL â†’ XPL
          const wxplContract = new Contract(WXPL, [
            'function withdraw(uint wad) external',
            'function balanceOf(address) view returns (uint)'
          ], signer);

          const wxplBalance = await wxplContract.balanceOf(owner);
          const amountIn = utils.parseUnits(amtStr, 18);

          if (wxplBalance.lt(amountIn)) {
            alert('Insufficient WXPL balance');
            return;
          }

          setStatus('Unwrapping WXPL...');
          const tx = await wxplContract.withdraw(amountIn, { gasLimit: 100000 });
          txHashEl.innerText = 'Tx: ' + tx.hash;
          await tx.wait();
          setStatus('Unwrap confirmed');
          alert('WXPL unwrapped to XPL successfully!');

        } else {
          // WRAP: XPL â†’ WXPL  
          const wxplContract = new Contract(WXPL, [
            'function deposit() payable external',
            'function balanceOf(address) view returns (uint)'
          ], signer);

          const amountIn = utils.parseUnits(amtStr, 18);
          const ethBalance = await provider.getBalance(owner);

          if (ethBalance.lt(amountIn)) {
            alert('Insufficient XPL balance');
            return;
          }

          setStatus('Wrapping XPL...');
          const tx = await wxplContract.deposit({ value: amountIn, gasLimit: 100000 });
          txHashEl.innerText = 'Tx: ' + tx.hash;
          await tx.wait();
          setStatus('Wrap confirmed');
          alert('XPL wrapped to WXPL successfully!');
        }

        // Update balances
        await updateBalances();
        computeOutput();

      } catch (e) {
        console.error('Unwrap error', e);
        alert('Unwrap failed: ' + (e.message || e));
        setStatus('Unwrap failed');
      }
    }

    // âœ… FUNGSI: Execute Swap biasa
    async function executeSwap() {
      try {
        if (!provider) return alert('Provider missing');
        if (!window.ethereum) return alert('Connect wallet first');
        if (!signer) signer = new providers.Web3Provider(window.ethereum).getSigner();

        const owner = await signer.getAddress();
        const from = selectedFromToken.address;
        const to = selectedToToken.address;
        const amtStr = (fromAmountEl.value || '').trim();

        if (!amtStr) return alert('Enter amount');

        const decFrom = from === 'XPL_NATIVE' ? 18 : await (new Contract(from, ERC20, provider)).decimals();
        const amountIn = utils.parseUnits(amtStr, decFrom);

        const allowanceOk = await hasAllowance(from, owner, amountIn);
        if (!allowanceOk) {
          const ok = confirm('Token not approved. Approve unlimited to router?');
          if (!ok) return;
          const res = await approveToken(from);
          if (!res) return;
        }

        const path = [from === 'XPL_NATIVE' ? WXPL : from, to === 'XPL_NATIVE' ? WXPL : to];
        const routerSigner = router.connect(signer);

        if (from === 'XPL_NATIVE') {
          const amounts = await router.getAmountsOut(amountIn, path);
          const out = amounts[amounts.length - 1];
          const sl = parseFloat(document.getElementById('slippage').value || 0.5);
          const slBps = Math.floor(sl * 100);
          const amountOutMin = out.mul(10000 - slBps).div(10000);
          const deadline = (await provider.getBlock('latest')).timestamp + (parseInt(document.getElementById('deadline').value || 10) * 60);

          setStatus('Sending swap (ETH) ...');
          const tx = await routerSigner.swapExactETHForTokens(amountOutMin, path, owner, deadline, { value: amountIn, gasLimit: 1500000 });
          txHashEl.innerText = 'Tx: ' + tx.hash;
          await tx.wait();
          setStatus('Swap confirmed');
          alert('Swap complete: ' + tx.hash);
          txHashEl.innerText = 'Tx: ' + tx.hash;
          updateBalances();
          computeOutput();
          return;
        }

        const amounts = await router.getAmountsOut(amountIn, path);
        const out = amounts[amounts.length - 1];
        const sl = parseFloat(document.getElementById('slippage').value || 0.5);
        const slBps = Math.floor(sl * 100);
        const amountOutMin = out.mul(10000 - slBps).div(10000);
        const deadline = (await provider.getBlock('latest')).timestamp + (parseInt(document.getElementById('deadline').value || 10) * 60);

        setStatus('Sending swap...');
        let tx;

        if (to === 'XPL_NATIVE') {
          tx = await routerSigner.swapExactTokensForETH(amountIn, amountOutMin, path, owner, deadline, { gasLimit: 1500000 });
        } else {
          tx = await routerSigner.swapExactTokensForTokens(amountIn, amountOutMin, path, owner, deadline, { gasLimit: 1500000 });
        }

        const scanUrl = `https://plasmascan.to/tx/${tx.hash}`;
        txHashEl.innerHTML = `
          <span class="text-gray-300 text-sm">Tx:</span>
          <a href="${scanUrl}" target="_blank" class="text-blue-400 hover:underline">
            ${tx.hash.slice(0, 10)}...${tx.hash.slice(-8)}
          </a>
        `;
        await tx.wait();
        setStatus('Swap confirmed');
        alert('Swap complete!');
        txHashEl.innerHTML = `
          <span class="text-gray-300 text-sm">Tx:</span>
          <a href="${scanUrl}" target="_blank" class="text-blue-400 hover:underline">
            ${tx.hash.slice(0, 10)}...${tx.hash.slice(-8)}
          </a>
        `;

        updateBalances();
        computeOutput();
      } catch (e) {
        console.error('Swap error', e);
        alert('Swap failed: ' + (e.message || e));
        setStatus('Swap failed');
      }
    }

    function setStatus(s) {
      if (statusEl) statusEl.innerText = s;
    }

    // WALLET CONNECTION
    async function ensureProvider() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: CHAIN_ID_HEX,
                  chainName: 'Plasma Chain',
                  rpcUrls: [RPC],
                  nativeCurrency: {
                    name: 'XPL',
                    symbol: 'XPL',
                    decimals: 18
                  },
                  blockExplorerUrls: ['https://plasmascan.to/']
                }]
              });
            } catch (addError) {
              console.warn('Failed to add chain:', addError);
            }
          }
        }

        provider = new providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        router = new Contract(ROUTER, ROUTER_ABI, provider);
        factory = new Contract(FACTORY, FACTORY_ABI, provider);

        try {
          const accounts = await provider.listAccounts();
          if (accounts && accounts.length > 0) {
            account = accounts[0];
            window.account = account;
            connectBtn.innerText = account.substring(0, 6) + '...' + account.substring(38);
            connectBtn.onclick = toggleWalletDropdown;
            setStatus('Connected');
            await updateBalances();
            await updateDropdownBalances();
            await updateUsdPrices();
          } else {
            setStatus('Ready to connect');
          }
        } catch (e) {
          console.warn('Account check failed:', e);
          setStatus('Ready to connect');
        }
      } else {
        provider = new providers.JsonRpcProvider(RPC);
        router = new Contract(ROUTER, ROUTER_ABI, provider);
        factory = new Contract(FACTORY, FACTORY_ABI, provider);
        setStatus('Read-only mode');
      }
    }

    // CONNECT BUTTON
    async function connectWallet() {
      if (!window.ethereum) {
        alert('MetaMask not detected. Please install MetaMask to connect your wallet.');
        return;
      }

      try {
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        if (accounts && accounts.length > 0) {
          account = accounts[0];
          window.account = account;
          provider = new providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          router = new Contract(ROUTER, ROUTER_ABI, provider);
          factory = new Contract(FACTORY, FACTORY_ABI, provider);

          // Update UI untuk connected state
          connectBtn.innerText = account.substring(0, 6) + '...' + account.substring(38);
          connectBtn.onclick = toggleWalletDropdown;
          setStatus('Connected');

          await updateBalances();
          await updateDropdownBalances();
          await updateUsdPrices();
          await computeOutput();

          showToast("Wallet connected successfully!");
        }
      } catch (error) {
        console.error('Connection failed:', error);
        if (error.code === 4001) {
          setStatus('Connection rejected');
          alert('Please connect your wallet to use CozySwap.');
        } else {
          setStatus('Connection failed');
          alert('Connection failed: ' + (error.message || error));
        }
      }
    }

    async function updateBalances() {
      try {
        if (!provider) return;
        if (!account) {
          if (provider.listAccounts) {
            const accts = await provider.listAccounts();
            account = accts && accts[0];
            window.account = account;
          }
        }

        if (!account) {
          fromBalanceEl.innerText = '-';
          toBalanceEl.innerText = '-';
          return;
        }

        // From balance
        const f = selectedFromToken.address;
        if (f === 'XPL_NATIVE') {
          const bal = await provider.getBalance(account);
          fromBalanceEl.innerText = parseFloat(utils.formatUnits(bal, 18)).toFixed(4);
        } else {
          const c = new Contract(f, ERC20, provider);
          const dec = await c.decimals();
          const bal = await c.balanceOf(account);
          fromBalanceEl.innerText = parseFloat(utils.formatUnits(bal, dec)).toFixed(4);
        }

        // To balance
        const t = selectedToToken.address;
        if (t === 'XPL_NATIVE') {
          const bal = await provider.getBalance(account);
          toBalanceEl.innerText = parseFloat(utils.formatUnits(bal, 18)).toFixed(4);
        } else {
          const c2 = new Contract(t, ERC20, provider);
          const dec2 = await c2.decimals();
          const bal2 = await c2.balanceOf(account);
          toBalanceEl.innerText = parseFloat(utils.formatUnits(bal2, dec2)).toFixed(4);
        }
      } catch (e) {
        console.warn('Balance error', e);
        fromBalanceEl.innerText = '-';
        toBalanceEl.innerText = '-';
      }
    }

    maxFromBtn.onclick = async () => {
      try {
        if (!account) return alert('Connect wallet');
        const f = selectedFromToken.address;
        if (f === 'XPL_NATIVE') {
          const bal = await provider.getBalance(account);
          fromAmountEl.value = utils.formatUnits(bal, 18);
        } else {
          const c = new Contract(f, ERC20, provider);
          const bal = await c.balanceOf(account);
          const dec = await c.decimals();
          fromAmountEl.value = utils.formatUnits(bal, dec);
        }
        computeOutput();
      } catch (e) {
        console.error(e);
      }
    };

    async function getPairReserves(tokenA, tokenB) {
      try {
        const a = tokenA === 'XPL_NATIVE' ? WXPL : tokenA;
        const b = tokenB === 'XPL_NATIVE' ? WXPL : tokenB;
        const pairAddr = await factory.getPair(a, b);
        if (!pairAddr || pairAddr === '0x0000000000000000000000000000000000000000') return null;

        const pair = new Contract(pairAddr, PAIR_ABI, provider);
        const reserves = await pair.getReserves();
        const t0 = await pair.token0();
        const t1 = await pair.token1();
        return { reserves, token0: t0, token1: t1 };
      } catch (e) {
        console.warn(e);
        return null;
      }
    }

    async function computeOutput() {
      try {
        const amtStr = (fromAmountEl.value || '').trim();
        if (!amtStr) {
          toReadable.innerText = 'â€”';
          priceImpactEl.innerText = 'Price impact: â€”';
          priceDisplay.innerText = '';
          return;
        }

        const from = selectedFromToken.address;
        const to = selectedToToken.address;

        const decFrom = from === 'XPL_NATIVE' ? 18 : await (new Contract(from, ERC20, provider)).decimals();
        const decTo = to === 'XPL_NATIVE' ? 18 : await (new Contract(to, ERC20, provider)).decimals();

        const amountIn = utils.parseUnits(amtStr, decFrom);
        const path = [from === 'XPL_NATIVE' ? WXPL : from, to === 'XPL_NATIVE' ? WXPL : to];

        let amounts;
        try {
          amounts = await router.getAmountsOut(amountIn, path);
        } catch (e) {
          toReadable.innerText = 'â€”';
          liquidityInfoEl.innerText = 'Pool: insufficient liquidity or pair missing';
          priceImpactEl.innerText = 'Price impact: â€”';
          priceDisplay.innerText = '';
          return;
        }

        const out = amounts[amounts.length - 1];
        
        // Format to max 6 decimals
        const formatted = utils.formatUnits(out, decTo);
        const [integerPart, decimalPart] = formatted.split('.');
        if (decimalPart && decimalPart.length > 6) {
           toReadable.innerText = `${integerPart}.${decimalPart.substring(0, 6)}`;
        } else {
           toReadable.innerText = formatted;
        }

        // PRICE UPDATE LOGIC
        const realPrice = Number(utils.formatUnits(out, decTo)) / Number(utils.formatUnits(amountIn, decFrom));
        if (priceDisplay && !isNaN(realPrice)) {
          priceDisplay.innerText = `1 ${selectedFromToken.symbol} = ${realPrice.toFixed(6)} ${selectedToToken.symbol}`;
        }

        const pair = await getPairReserves(from, to);
        if (!pair) {
          priceImpactEl.innerText = 'â€”';
          liquidityInfoEl.innerText = 'Pool not found';
          return;
        }

        const { reserves, token0 } = pair;
        let reserveIn = reserves[0], reserveOut = reserves[1];
        if (token0.toLowerCase() !== (from === 'XPL_NATIVE' ? WXPL : from).toLowerCase()) {
          reserveIn = reserves[1];
          reserveOut = reserves[0];
        }

        const reserveInFloat = Number(utils.formatUnits(reserveIn, decFrom));
        const reserveOutFloat = Number(utils.formatUnits(reserveOut, decTo));
        if (reserveInFloat === 0 || reserveOutFloat === 0) {
          priceImpactEl.innerText = 'â€”';
          return;
        }

        const ideal = reserveOutFloat / reserveInFloat;
        const real = Number(utils.formatUnits(out, decTo)) / Number(utils.formatUnits(amountIn, decFrom));
        const impact = Math.abs((ideal - real) / ideal) * 100;
        const impactFixed = impact.toFixed(2) + '%';

        if (impact < 1) priceImpactEl.innerHTML = `<span class="green">${impactFixed}</span>`;
        else if (impact < 5) priceImpactEl.innerHTML = `<span class="yellow">${impactFixed}</span>`;
        else priceImpactEl.innerHTML = `<span class="red">${impactFixed}</span>`;

        liquidityInfoEl.innerText = 'Pool reserves OK';
      } catch (e) {
        console.error('computeOutput', e);
      }
    }

    fromAmountEl.addEventListener('input', debounce(computeOutput, 400));

    flipBtn.onclick = () => {
      const temp = selectedFromToken;
      selectedFromToken = selectedToToken;
      selectedToToken = temp;
      selectToken('from', selectedFromToken);
      selectToken('to', selectedToToken);
    };

    async function hasAllowance(tokenAddr, owner, amount) {
      try {
        if (tokenAddr === 'XPL_NATIVE') return true;
        const c = new Contract(tokenAddr, ERC20, provider);
        const al = await c.allowance(owner, ROUTER);
        return al.gte(amount);
      } catch (e) {
        console.warn('Allowance check failed', e);
        return false;
      }
    }

    async function approveToken(tokenAddr) {
      try {
        if (!signer) throw new Error('Wallet not connected');
        const c = new Contract(tokenAddr, ERC20, signer);
        const tx = await c.approve(ROUTER, ethers.constants.MaxUint256);
        setStatus('Approving...');
        await tx.wait();
        setStatus('Approved');
        return true;
      } catch (e) {
        console.error('Approve error', e);
        alert('Approve failed: ' + (e.message || e));
        return false;
      }
    }

    async function refreshButtonState() {
      try {
        if (!provider) return;
        if (!window.ethereum) {
          approveOrSwapBtn.innerText = 'Swap (connect)';
          return;
        }

        if (!signer) signer = new providers.Web3Provider(window.ethereum).getSigner();
        const owner = await signer.getAddress();
        const from = selectedFromToken.address;
        const amtStr = (fromAmountEl.value || '').trim();

        if (!amtStr) {
          return;
        }

        const decFrom = from === 'XPL_NATIVE' ? 18 : await (new Contract(from, ERC20, provider)).decimals();
        const amountIn = utils.parseUnits(amtStr, decFrom);
        const ok = await hasAllowance(from, owner, amountIn);

        // Hanya update text jika button dalam mode Swap
        if (approveOrSwapBtn.textContent === 'Swap') {
          approveOrSwapBtn.innerText = ok ? 'Swap' : 'Approve';
        }
      } catch (e) {
        console.warn('Refresh button', e);
      }
    }

    setInterval(() => {
      if (window.ethers || window.ethereum) refreshButtonState();
    }, 1500);

    // Initialize
    await ensureProvider();
    refreshSelectors();
    await updateBalances();
    computeOutput();
    // updateUsdPrices called in ensureProvider

    // Set event listener untuk connect button
    connectBtn.onclick = connectWallet;

    // Navigation URLs
    // Removed direct click handlers for toLiquidity/toStaking as they are now links

    function debounce(fn, ms) {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    }

  })();
  </script>
  <script src="appkit.bundle.js"></script>
</body>
</html>
