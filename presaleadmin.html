<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$COZY Presale Admin - Full Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .admin-container {
            max-width: 1000px;
            margin: 30px auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #fdbb2d;
            padding-bottom: 20px;
        }
        
        .admin-header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .admin-badge {
            background: #b21f1f;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }
        
        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .wallet-info {
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(45deg, #f57c00, #ff9800);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(45deg, #ff4b2b, #ff416c);
        }
        
        .btn-info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }
        
        .btn-info:hover {
            background: linear-gradient(45deg, #1976D2, #2196F3);
        }
        
        .contract-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            word-break: break-all;
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .function-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #fdbb2d;
        }
        
        .function-card h3 {
            color: #fdbb2d;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fdbb2d;
            margin-top: 5px;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
        }
        
        .status-active {
            background: #4CAF50;
        }
        
        .status-inactive {
            background: #ff4444;
        }
        
        .warning-box {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #fdbb2d;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #444;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõãÔ∏è $COZY Presale Admin Panel</h1>
            <div class="admin-badge">OWNER ACCESS ONLY - PLASMA NETWORK</div>
        </div>

        <!-- Wallet Connection Section -->
        <div class="wallet-section">
            <button class="btn btn-primary" onclick="connectWallet()" id="connectBtn">
                üîó Connect Wallet (Plasma)
            </button>
            <div id="walletInfo" style="display: none;">
                <div class="wallet-info">Connected: <span id="walletAddress"></span></div>
                <div class="wallet-info">Network: <span id="networkInfo"></span></div>
            </div>
        </div>

        <div class="contract-info">
            <strong>Presale Contract:</strong><br>
            0x79a181f1Fe2d32bEeA74505A78ACAef1e1Bbe2C8
        </div>

        <div class="warning-box">
            ‚ö†Ô∏è <strong>WARNING:</strong> Owner functions only. Plasma Network required.
        </div>

        <!-- Presale Control Functions -->
        <div class="function-grid">
            <!-- Activate Presale -->
            <div class="function-card">
                <h3>üöÄ ACTIVATE PRESALE</h3>
                <p>Start the 3-month presale period</p>
                <button class="btn btn-primary" onclick="activatePresale()" id="activateBtn">
                    Activate Presale
                </button>
            </div>

            <!-- Finalize Presale -->
            <div class="function-card">
                <h3>üèÅ FINALIZE PRESALE</h3>
                <p>End presale and enable token claims</p>
                <button class="btn btn-warning" onclick="finalizePresale()" id="finalizeBtn">
                    Finalize Presale
                </button>
            </div>

            <!-- Withdraw XPL -->
            <div class="function-card">
                <h3>üí∞ WITHDRAW XPL</h3>
                <p>Withdraw raised funds (after finalization)</p>
                <button class="btn btn-info" onclick="withdrawXPL()" id="withdrawBtn">
                    Withdraw XPL
                </button>
            </div>

            <!-- Withdraw Unsold Tokens -->
            <div class="function-card">
                <h3>üéØ WITHDRAW UNSOLD TOKENS</h3>
                <p>Recover unsold COZY tokens</p>
                <button class="btn btn-info" onclick="withdrawUnsoldTokens()" id="unsoldBtn">
                    Withdraw Unsold
                </button>
            </div>

            <!-- Recover ERC20 -->
            <div class="function-card">
                <h3>üîÑ RECOVER OTHER TOKENS</h3>
                <p>Recover accidental ERC20 tokens</p>
                <div class="input-group">
                    <label>Token Address:</label>
                    <input type="text" id="tokenAddress" placeholder="0x...">
                </div>
                <button class="btn btn-warning" onclick="recoverERC20()">
                    Recover Token
                </button>
            </div>

            <!-- Emergency Refund Enable -->
            <div class="function-card">
                <h3>üÜò EMERGENCY REFUND</h3>
                <p>Enable refunds if soft cap not reached</p>
                <button class="btn btn-danger" onclick="enableRefund()" id="refundBtn">
                    Enable Refunds
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h3>üìä PRESALE STATUS</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div>Presale Active</div>
                    <div class="status-value" id="presaleActive">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Finalized</div>
                    <div class="status-value" id="presaleFinalized">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Refund Enabled</div>
                    <div class="status-value" id="refundEnabled">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Total Raised</div>
                    <div class="status-value" id="totalRaised">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Tokens Sold</div>
                    <div class="status-value" id="tokensSold">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Contract XPL Balance</div>
                    <div class="status-value" id="contractBalance">Loading...</div>
                </div>
                <div class="status-item">
                    <div>COZY Balance</div>
                    <div class="status-value" id="cozyBalance">Loading...</div>
                </div>
                <div class="status-item">
                    <div>Start Time</div>
                    <div class="status-value" id="startTime">Loading...</div>
                </div>
                <div class="status-item">
                    <div>End Time</div>
                    <div class="status-value" id="endTime">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, contract;
        const CONTRACT_ADDRESS = "0x79a181f1Fe2d32bEeA74505A78ACAef1e1Bbe2C8";
        const COZY_TOKEN_ADDRESS = "0x06E2Ef46662834F4E42dBf9fF9222B077C57dF5C";
        
        // ABI untuk Presale Contract
        const PRESALE_ABI = [
            "function activatePresale() external onlyOwner",
            "function finalizePresale() external onlyOwner",
            "function withdrawXPL() external onlyOwner",
            "function withdrawUnsoldTokens() external onlyOwner",
            "function recoverERC20(address tokenAddr) external onlyOwner",
            "function presaleActive() public view returns (bool)",
            "function presaleFinalized() public view returns (bool)",
            "function refundEnabled() public view returns (bool)",
            "function totalRaised() public view returns (uint256)",
            "function totalTokensSold() public view returns (uint256)",
            "function startTime() public view returns (uint256)",
            "function endTime() public view returns (uint256)",
            "function owner() public view returns (address)"
        ];
        
        // ABI untuk COZY Token (ERC20)
        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, PRESALE_ABI, signer);
                    
                    const address = await signer.getAddress();
                    const network = await provider.getNetwork();
                    
                    document.getElementById('walletAddress').textContent = address;
                    document.getElementById('networkInfo').textContent = `Chain ID: ${network.chainId}`;
                    document.getElementById('walletInfo').style.display = 'block';
                    document.getElementById('connectBtn').textContent = '‚úÖ Connected';
                    
                    // Load contract status
                    await loadContractStatus();
                    setInterval(loadContractStatus, 10000); // Update every 10 seconds
                    
                } else {
                    alert('Please install MetaMask or compatible wallet!');
                }
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function loadContractStatus() {
            try {
                if (!contract) return;
                
                const [
                    presaleActive,
                    presaleFinalized,
                    refundEnabled,
                    totalRaised,
                    totalTokensSold,
                    startTime,
                    endTime,
                    contractBalance,
                    cozyBalance
                ] = await Promise.all([
                    contract.presaleActive(),
                    contract.presaleFinalized(),
                    contract.refundEnabled(),
                    contract.totalRaised(),
                    contract.totalTokensSold(),
                    contract.startTime(),
                    contract.endTime(),
                    provider.getBalance(CONTRACT_ADDRESS),
                    getCozyBalance()
                ]);
                
                // Update UI
                document.getElementById('presaleActive').textContent = presaleActive ? '‚úÖ YES' : '‚ùå NO';
                document.getElementById('presaleFinalized').textContent = presaleFinalized ? '‚úÖ YES' : '‚ùå NO';
                document.getElementById('refundEnabled').textContent = refundEnabled ? '‚úÖ YES' : '‚ùå NO';
                document.getElementById('totalRaised').textContent = ethers.utils.formatEther(totalRaised) + ' XPL';
                document.getElementById('tokensSold').textContent = ethers.utils.formatEther(totalTokensSold) + ' COZY';
                document.getElementById('startTime').textContent = startTime.gt(0) ? new Date(startTime.mul(1000).toNumber()).toLocaleString() : 'Not Started';
                document.getElementById('endTime').textContent = endTime.gt(0) ? new Date(endTime.mul(1000).toNumber()).toLocaleString() : 'Not Set';
                document.getElementById('contractBalance').textContent = ethers.utils.formatEther(contractBalance) + ' XPL';
                document.getElementById('cozyBalance').textContent = ethers.utils.formatEther(cozyBalance) + ' COZY';
                
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        async function getCozyBalance() {
            try {
                const tokenContract = new ethers.Contract(COZY_TOKEN_ADDRESS, TOKEN_ABI, provider);
                return await tokenContract.balanceOf(CONTRACT_ADDRESS);
            } catch (error) {
                return ethers.BigNumber.from(0);
            }
        }

        async function activatePresale() {
            try {
                if (!confirm('Activate presale for 3 months? This cannot be undone!')) return;
                
                document.getElementById('activateBtn').classList.add('loading');
                document.getElementById('activateBtn').textContent = 'Activating...';
                
                const tx = await contract.activatePresale();
                await tx.wait();
                
                alert('‚úÖ Presale activated successfully!');
                await loadContractStatus();
                
            } catch (error) {
                alert('‚ùå Activation failed: ' + error.message);
            } finally {
                document.getElementById('activateBtn').classList.remove('loading');
                document.getElementById('activateBtn').textContent = 'Activate Presale';
            }
        }

        async function finalizePresale() {
            try {
                if (!confirm('Finalize presale? This will enable token claims.')) return;
                
                document.getElementById('finalizeBtn').classList.add('loading');
                document.getElementById('finalizeBtn').textContent = 'Finalizing...';
                
                const tx = await contract.finalizePresale();
                await tx.wait();
                
                alert('‚úÖ Presale finalized successfully!');
                await loadContractStatus();
                
            } catch (error) {
                alert('‚ùå Finalization failed: ' + error.message);
            } finally {
                document.getElementById('finalizeBtn').classList.remove('loading');
                document.getElementById('finalizeBtn').textContent = 'Finalize Presale';
            }
        }

        async function withdrawXPL() {
            try {
                if (!confirm('Withdraw all XPL from contract to owner?')) return;
                
                document.getElementById('withdrawBtn').classList.add('loading');
                document.getElementById('withdrawBtn').textContent = 'Withdrawing...';
                
                const tx = await contract.withdrawXPL();
                await tx.wait();
                
                alert('‚úÖ XPL withdrawn successfully!');
                await loadContractStatus();
                
            } catch (error) {
                alert('‚ùå Withdrawal failed: ' + error.message);
            } finally {
                document.getElementById('withdrawBtn').classList.remove('loading');
                document.getElementById('withdrawBtn').textContent = 'Withdraw XPL';
            }
        }

        async function withdrawUnsoldTokens() {
            try {
                if (!confirm('Withdraw unsold COZY tokens?')) return;
                
                document.getElementById('unsoldBtn').classList.add('loading');
                document.getElementById('unsoldBtn').textContent = 'Withdrawing...';
                
                const tx = await contract.withdrawUnsoldTokens();
                await tx.wait();
                
                alert('‚úÖ Unsold tokens withdrawn!');
                await loadContractStatus();
                
            } catch (error) {
                alert('‚ùå Withdrawal failed: ' + error.message);
            } finally {
                document.getElementById('unsoldBtn').classList.remove('loading');
                document.getElementById('unsoldBtn').textContent = 'Withdraw Unsold';
            }
        }

        async function recoverERC20() {
            try {
                const tokenAddress = document.getElementById('tokenAddress').value;
                if (!tokenAddress || !ethers.utils.isAddress(tokenAddress)) {
                    alert('Please enter a valid token address');
                    return;
                }
                
                if (!confirm(`Recover ERC20 tokens from ${tokenAddress}?`)) return;
                
                const tx = await contract.recoverERC20(tokenAddress);
                await tx.wait();
                
                alert('‚úÖ Tokens recovered successfully!');
                
            } catch (error) {
                alert('‚ùå Recovery failed: ' + error.message);
            }
        }

        async function enableRefund() {
            try {
                if (!confirm('Enable emergency refunds? This allows investors to claim refunds.')) return;
                
                document.getElementById('refundBtn').classList.add('loading');
                document.getElementById('refundBtn').textContent = 'Enabling...';
                
                // Note: This function doesn't exist in your contract
                // You might need to add it or use finalizePresale when soft cap not reached
                alert('‚ö†Ô∏è Refund is automatically enabled if soft cap not reached after finalization');
                
            } catch (error) {
                alert('‚ùå Operation failed: ' + error.message);
            } finally {
                document.getElementById('refundBtn').classList.remove('loading');
                document.getElementById('refundBtn').textContent = 'Enable Refunds';
            }
        }

        // Auto-connect if previously connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });
    </script>
</body>
</html>